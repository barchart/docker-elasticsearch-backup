#!/bin/bash

. /etc/environment

if curl -XGET "http://${ES_HOST}/_snapshot/${ES_REPOSITORY_NAME}" | grep -q "\"error\"";  then
	if test -n "${ES_REPOSITORY_CREATE_}"; then
		curl -XPUT "http://${ES_HOST}/_snapshot/${ES_REPOSITORY_NAME}" -d "${ES_REPOSITORY_CREATE}"
	fi
fi

# Timestamped snapshot
SNAPSHOT=`date +%Y%m%d-%H%M%S`

curl -XPUT "http://${ES_HOST}/_snapshot/${ES_REPOSITORY_NAME}/${SNAPSHOT}" -d "{
	\"ignore_unavailable\": \"${ES_IGNORE_UNAVAILABLE}\",
	\"include_global_state\": ${ES_GLOBAL_STATE}
}"
