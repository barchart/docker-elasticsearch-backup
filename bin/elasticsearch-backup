#!/bin/bash

. /etc/environment

if curl -XGET "http://${ES_HOST}/_snapshot/${ES_REPOSITORY_NAME}" | grep -q "\"error\"";  then
	echo "No repository exists"
	if test -n "${ES_REPOSITORY_CREATE}"; then
		echo "Creating new repository as ${ES_REPOSITORY_CREATE}"
		curl -XPUT "http://${ES_HOST}/_snapshot/${ES_REPOSITORY_NAME}" -d "${ES_REPOSITORY_CREATE}"
	fi
fi

# Timestamped snapshot
SNAPSHOT=`date +%Y%m%d-%H%M%S`
echo "Starting snapshot ${SNAPSHOT}"

curl -XPUT "http://${ES_HOST}/_snapshot/${ES_REPOSITORY_NAME}/${SNAPSHOT}" -d "{
	\"ignore_unavailable\": \"${ES_IGNORE_UNAVAILABLE}\",
	\"include_global_state\": ${ES_GLOBAL_STATE}
}"

echo "Snapshot complete"
